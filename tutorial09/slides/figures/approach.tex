\documentclass{standalone}
\usepackage[utf8]{inputenc}
\usepackage{tikz}
\usepackage{pgf}
\usetikzlibrary{arrows,positioning,backgrounds,calc}
\usepackage{hyperref}

\begin{document}

\setlength{\parindent}{0pt} % Einrücken der ersten Zeile
\setlength{\parskip}{10pt}   % Abstand zwischen den Absätzen

\tikzstyle{materia_blue}=[draw, fill=blue!20, text width=6.0em, text centered,
  minimum height=1.5em]

\begin{tikzpicture}[transform shape]
  \path node (p1) [materia_blue, text width=18em, minimum width=10em, minimum height=3em, rounded corners]{Mathematical problem\\{\scriptsize\textit{PDE problem in residual formulation}}};
  \path (p1.south) + (0.0, -1.0) node (p2) [materia_blue, text width=18em, minimum width=10em, minimum height=3em, rounded corners]{UFL\\{\scriptsize\textit{Python formulation in domain specific language}}};
  \path (p2.south) + (0.0, -1.0) node (p3) [materia_blue, text width=18em, minimum width=10em, minimum height=3em, rounded corners]{preprocessed UFL\\{\scriptsize\textit{Apply preprocessing from UFL with custom extensions}}};
  \path (p3.south) + (0.0, -2.0) node (p4) [materia_blue, text width=18em, minimum width=10em, minimum height=3em, rounded corners]{loo.py: intermediate representation\\{\scriptsize\textit{of the loop nest for the PDE kernel}}};
  \path (p4.south) + (0.0, -3.0) node (p5) [materia_blue, text width=18em, minimum width=10em, minimum height=3em, rounded corners]{C++ PDELab code\\{\scriptsize\textit{LocalOperator, driver and parameter class}}};
  \path (p5.east) + (3.0, 0.0) node (p6) [materia_blue, text width=10em, minimum width=6em, minimum height=3em, rounded corners]{Vectorization Backend\\{\scriptsize\textit{VC, VCL: C++ intrisics wrapper}}};
  \path (p5.south) + (0.0, -1.0) node (p7) [materia_blue, text width=18em, minimum width=6em, minimum height=3em, rounded corners]{Automated analysis and profiling\\{\scriptsize\textit{of compiled source}}};
  \path (p5.west) + (-3.0, 0.0) node (p15) [materia_blue, text width=10em, minimum width=6em, minimum height=3em, rounded corners]{Dune Highlevel Backend\\{\scriptsize\textit{to grid, geometry and basis}}};
  \draw[-latex] (p1.south) -- (p2.north);
  \draw[-latex] (p2.south) -- (p3.north);
  \draw[-latex] (p3.south) -- (p4.north);

  \draw ($ (p4.north) + (0.0, -2.25) $) node[text width=18em, text centered]{transformations};
  \draw ($ (p2.north) + (-6.25, -0.25) $) node[text width=18em, text centered]{Numerics};
  \draw ($ (p2.north) + (6.25, -0.25) $) node[text width=18em, text centered]{Hardware};
  \draw [-latex] ($ (p4.south) + (0, -0.15)$) arc [start angle=-260, end angle=80, x radius=.8cm, y radius=.8cm];

  \begin{pgfonlayer}{background}
    \draw[draw=black!50, rounded corners=2mm, fill = yellow!20] ($ (p4.north) + (-4.0, 0.6) $) rectangle ($ (4.0, 0.5) + (p5.north) $);
    \draw[draw=black!50, rounded corners=2mm, fill = green!20] ($ (p2.north) + (-8.0, 0.0) $) rectangle ($ (-4.5, 0.5) + (p5.north) $);
    \draw[draw=black!50, rounded corners=2mm, fill = red!20] ($ (p2.north) + (8.0, 0.0) $) rectangle ($ (4.5, 0.5) + (p5.north) $);
  \end{pgfonlayer}

  \draw[-latex] ($ (p4.south) + (-2.0, 0.0) $) -- ($ (p5.north) +  (-2.0, 0.0) $);
  \draw[-latex] ($ (p6.north) + (0.0, 1.0) $) -- (p6.north);
  \draw[-latex] (p6.west) -- (p5.east);
  \draw[-latex] (p15.east) -- (p5.west);
  \draw[-latex] ($ (p15.north) + (0.0, 1.0) $) -- (p15.north);
  \draw[-latex] (p5.south) -- (p7.north);
  \draw[-latex] (p7.east) -- ++(0.4, 0.0) -- ++(0.0, 2.3) -- ++(-1.0,0.0) -- ++(0.0, 0.6);
  \draw[-latex] ($ (4.5, 1.0) + (p5.north) $) -- ++(-1.0, 0.0);
  \draw[-latex] ($ (4.5, 2.0) + (p5.north) $) -- ++(-1.0, 0.0);
  \draw[-latex] ($ (4.5, 3.0) + (p5.north) $) -- ++(-1.0, 0.0);
  \draw[-latex] ($ (4.5, 4.0) + (p5.north) $) -- ++(-1.0, 0.0);

  \draw[-latex] ($ (-4.5, 1.0) + (p5.north) $) -- ++(1.0, 0.0);
  \draw[-latex] ($ (-4.5, 2.0) + (p5.north) $) -- ++(1.0, 0.0);
  \draw[-latex] ($ (-4.5, 3.0) + (p5.north) $) -- ++(1.0, 0.0);
  \draw[-latex] ($ (-4.5, 4.0) + (p5.north) $) -- ++(1.0, 0.0);

  \path (p2.south) + (-6.25, -0.5) node (p8) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{Basis structure};
  \path (p8.south) + (0.0, -1.0) node (p9) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{Polynomial Degree};
  \path (p9.south) + (0.0, -1.0) node (p10) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{Grid};
  \path (p10.south) + (0.0, -1.0) node (p11) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{...};

  \path (p2.south) + (6.25, -0.5) node (p12) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{Multithreading};
  \path (p12.south) + (0.0, -1.0) node (p13) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{Memory bandwidth};
  \path (p13.south) + (0.0, -1.0) node (p14) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{SIMD units};
  \path (p14.south) + (0.0, -1.0) node (p16) [materia_blue, text width=8em, minimum width=6em, minimum height=3em, rounded corners]{...};
\end{tikzpicture}

\end{document}
